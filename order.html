<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking & Checkout | SESA Coffee Official</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #2c1b0e; --accent: #c5a059; --cream: #fdfaf5; --white: #ffffff; --success: #27ae60; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--cream); color: var(--primary); }

        header { background: var(--white); position: sticky; top: 0; z-index: 4000; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .navbar { padding: 1.2rem 8%; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: 'Playfair Display'; font-size: 1.8rem; font-weight: 700; color: var(--primary); text-decoration: none; }
        .nav-links { display: flex; gap: 30px; list-style: none; align-items: center; }
        .nav-links a { text-decoration: none; color: var(--primary); font-weight: 500; text-transform: uppercase; font-size: 0.85rem; }
        .menu-dots { display: none; cursor: pointer; font-size: 1.5rem; }

        .container { padding: 40px 8%; max-width: 1000px; margin: auto; }
        .card { background: white; padding: 40px; border-radius: 35px; box-shadow: 0 15px 45px rgba(0,0,0,0.05); margin-bottom: 35px; }
        
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f5f5f5; }
        .qty-btn { background: #f0f0f0; border: none; width: 35px; height: 35px; border-radius: 10px; cursor: pointer; font-weight: 800; }
        
        .form-group { margin-bottom: 25px; }
        .form-group label { display: block; font-weight: 700; font-size: 0.8rem; margin-bottom: 10px; color: #777; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 18px; border: 2px solid #f5f5f5; border-radius: 18px; outline: none; }

        .pay-box { display: none; background: #fffcf5; padding: 30px; border-radius: 25px; border-left: 6px solid var(--accent); margin-top: 20px; text-align: center; }
        .btn-order { background: var(--primary); color: white; border: none; padding: 22px; border-radius: 25px; width: 100%; font-weight: 800; font-size: 1.2rem; cursor: pointer; transition: 0.3s; }

        /* CLOCK ANIMATION */
        .clock-wall { width: 80px; height: 80px; border: 6px solid var(--primary); border-radius: 50%; position: relative; margin: 20px auto; }
        .hand { width: 4px; background: var(--primary); position: absolute; bottom: 50%; left: 50%; transform-origin: bottom center; border-radius: 4px; }
        .hour { height: 20px; animation: rot 12s linear infinite; }
        .minute { height: 30px; animation: rot 2s linear infinite; }
        @keyframes rot { from { transform: translateX(-50%) rotate(0deg); } to { transform: translateX(-50%) rotate(360deg); } }

        /* TRACK SLIDER */
        .track-slider { display: flex; overflow-x: auto; gap: 20px; padding-bottom: 20px; scrollbar-width: none; }
        .track-card { min-width: 300px; background: #fffcf5; border: 3px dashed var(--accent); padding: 30px; border-radius: 30px; text-align: center; }
        .ready-anim { background: var(--success); color: white; padding: 15px; border-radius: 15px; font-weight: 800; animation: pulse 1s infinite; margin-top: 20px; }
        @keyframes pulse { 0%, 100% { opacity:0.8; } 50% { opacity:1; } }

        @media (max-width: 768px) {
            .nav-links { display: none; position: absolute; top: 100%; left: 0; width: 100%; background: white; flex-direction: column; padding: 25px; }
            .nav-links.show { display: flex; }
            .menu-dots { display: block; }
            .container { padding: 20px 5%; }
        }
    </style>
</head>
<body>

    <header>
        <nav class="navbar">
            <a href="index.html" class="logo">SESA <span>Coffee</span></a>
            <div class="menu-dots" onclick="toggleN()"><i class="fas fa-ellipsis-v"></i></div>
            <ul class="nav-links" id="nav-o">
                <li><a href="index.html">Home</a></li>
                <li><a href="menu.html">Menu</a></li>
                <li><a href="order.html" class="active">Order</a></li>
                <li><a href="location.html">Location</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </nav>
    </header>

    <div class="container">
        
        <!-- SECTION 1: CHECKOUT -->
        <div id="check-area">
            <button class="back-btn" style="background:none; border:none; color:var(--accent); font-weight:800; cursor:pointer; margin-bottom:20px;" onclick="location.href='menu.html'"><i class="fas fa-arrow-left"></i> KEMBALI KE MENU</button>
            <div class="card">
                <h2 style="font-family:'Playfair Display'; font-size:2rem; margin-bottom:25px;">Detail Keranjang</h2>
                <div id="cart-list"></div>
                <div style="margin-top:30px; border-top:3px dashed #eee; padding-top:25px; display:flex; justify-content:space-between; font-size:1.6rem; font-weight:900;">
                    <span>Total</span><span id="g-total" style="color:var(--accent);">Rp 0</span>
                </div>
            </div>

            <div class="card">
                <h2 style="font-family:'Playfair Display'; font-size:2rem; margin-bottom:25px;">Data Pengiriman</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div class="form-group"><label>Nama Lengkap</label><input type="text" id="c-name" placeholder="Atas nama siapa?"></div>
                    <div class="form-group"><label>Nomor Meja</label><input type="number" id="c-table" placeholder="00"></div>
                </div>
                <div class="form-group"><label>Instruksi / Catatan Khusus</label><textarea id="c-note" rows="3" placeholder="Contoh: Kurang gula, ekstra es..."></textarea></div>
                <div class="form-group">
                    <label>Metode Pembayaran</label>
                    <select id="p-method" onchange="showP()">
                        <option value="">-- PILIH PEMBAYARAN --</option>
                        <option value="qris">SCAN QRIS (DARI HP ANDA)</option>
                        <option value="bank">TRANSFER BCA (8830192332)</option>
                        <option value="kasir">BAYAR TUNAI DI KASIR</option>
                    </select>
                </div>

                <div id="p-qris" class="pay-box">
                    <i class="fas fa-qrcode fa-5x"></i><br><br>
                    <strong>SCAN QRIS SESA OFFICIAL:</strong><br>Silahkan scan barcode di atas langsung dari layar HP Anda. Pesanan akan diproses otomatis.
                </div>
                <div id="p-bank" class="pay-box">
                    <i class="fas fa-university fa-3x"></i><br><br>
                    <strong>BCA: 8830 192 332</strong><br>A/N PT SESA COFFEE INDONESIA. Simpan bukti transfer untuk divalidasi.
                </div>
                <div id="p-kasir" class="pay-box">
                    <i class="fas fa-cash-register fa-3x"></i><br><br>
                    <strong>BAYAR DI KASIR:</strong><br>Sebutkan nama Anda di meja kasir untuk pembayaran tunai sebelum pesanan diproses.
                </div>

                <button class="btn-order" style="margin-top:30px;" onclick="submitOrder()">KIRIM PESANAN KE DAPUR <i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- SECTION 2: MULTI TRACKING -->
        <div id="track-area">
            <h2 style="font-family:'Playfair Display'; margin-bottom:25px;"><i class="fas fa-history"></i> Lacak Pesanan Anda</h2>
            <div class="track-slider" id="active-tracks">
                <!-- Pesanan-pesanan yang sedang berjalan -->
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBAB3uy7JyIA38KMKGOFJb9_r5lJ3hTaNE",
            authDomain: "sesa-coffee.firebaseapp.com",
            databaseURL: "https://sesa-coffee-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sesa-coffee",
            storageBucket: "sesa-coffee.firebasestorage.app",
            messagingSenderId: "767835800976",
            appId: "1:767835800976:web:21ab01c3ff9bb29aae5f15"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let cart = JSON.parse(localStorage.getItem('sesa_cart')) || [];
        
        window.renderOrder = () => {
            const list = document.getElementById('cart-list'); list.innerHTML = "";
            let total = 0;
            if(cart.length === 0) {
                list.innerHTML = "<p style='text-align:center; padding:30px; color:#aaa;'>Keranjang kosong.</p>";
                document.getElementById('check-area').style.display = 'none';
            } else {
                document.getElementById('check-area').style.display = 'block';
            }
            cart.forEach((i, idx) => {
                total += (i.price * i.qty);
                list.innerHTML += `
                    <div class="item-row">
                        <div><b>${i.name}</b><br><small>Rp ${i.price.toLocaleString()}</small></div>
                        <div class="qty-ctrl">
                            <button class="qty-btn" onclick="upQ(${idx},-1)">-</button>
                            <span style="font-weight:700;">${i.qty}</span>
                            <button class="qty-btn" onclick="upQ(${idx},1)">+</button>
                        </div>
                    </div>`;
            });
            document.getElementById('g-total').innerText = "Rp " + total.toLocaleString();
            localStorage.setItem('sesa_cart', JSON.stringify(cart));
        };

        window.upQ = (idx, c) => { cart[idx].qty += c; if(cart[idx].qty < 1) cart.splice(idx,1); renderOrder(); };

        window.showP = () => {
            document.querySelectorAll('.pay-box').forEach(b => b.style.display = "none");
            const v = document.getElementById('p-method').value;
            if(v) document.getElementById('p-'+v).style.display = "block";
        };

        window.submitOrder = () => {
            const name = document.getElementById('c-name').value;
            const table = document.getElementById('c-table').value;
            const pay = document.getElementById('p-method').value;
            if(!name || !table || !pay || cart.length === 0) return alert("Mohon lengkapi data!");

            const id = "ORD_" + Date.now();
            const now = new Date();
            set(ref(db, 'orders/' + id), {
                id, customer: name, table, note: document.getElementById('c-note').value,
                payment: pay.toUpperCase(), items: cart,
                total: cart.reduce((s,i) => s+(i.price*i.qty), 0),
                status: 'MENUNGGU', fullTime: now.toLocaleString('id-ID'),
                month: now.toLocaleString('id-ID', {month:'long'}).toUpperCase()
            }).then(() => {
                let tracks = JSON.parse(localStorage.getItem('sesa_tracks')) || [];
                tracks.push(id);
                localStorage.setItem('sesa_tracks', JSON.stringify(tracks));
                localStorage.removeItem('sesa_cart');
                alert("Pesanan Terkirim! Anda bisa pesan lagi.");
                location.reload();
            });
        };

        // --- MULTI TRACKING LOGIC ---
        const activeTracks = JSON.parse(localStorage.getItem('sesa_tracks')) || [];
        const trackListUI = document.getElementById('active-orders-list');
        if(activeTracks.length === 0) document.getElementById('track-area').style.display = 'none';

        activeTracks.forEach(tid => {
            onValue(ref(db, 'orders/' + tid), (snap) => {
                const o = snap.val();
                let ex = document.getElementById('trk-'+tid);
                if(!o) {
                    if(ex) ex.innerHTML = "<div class='track-card'><h3>PESANAN SELESAI!</h3><p>Diterima & Nikmati!</p><button class='btn-order' style='padding:10px; font-size:0.7rem;' onclick='delTrk(\""+tid+"\")'>TUTUP INFO</button></div>";
                    return;
                }
                const html = `
                    <div class="track-card" id="trk-${tid}">
                        <h2 style="font-family:'Playfair Display'; color:var(--accent); font-size:1.2rem;">${o.customer}</h2>
                        <div class="clock-wall"><div class="hand hour"></div><div class="hand minute"></div></div>
                        <p style="font-size:0.8rem;">Status: <b>${o.status}</b></p>
                        ${o.status === 'PROSES' ? `<p style="font-size:0.8rem;">Estimasi: <b>${o.estTime} Menit</b></p>` : ''}
                        ${o.status === 'SIAP' ? `<div class="ready-anim">PESANAN AKAN SEGERA DIANTAR!</div>` : ''}
                        <button class="btn-order" style="padding:10px; margin-top:15px; font-size:0.7rem; background:#f0f0f0; color:#333;" onclick="location.href='menu.html'">PESAN LAGI</button>
                    </div>`;
                if(ex) ex.outerHTML = html;
                else document.getElementById('active-tracks').innerHTML += html;
            });
        });

        window.delTrk = (id) => {
            let t = JSON.parse(localStorage.getItem('sesa_tracks'));
            t = t.filter(x => x !== id);
            localStorage.setItem('sesa_tracks', JSON.stringify(t));
            location.reload();
        };

        window.toggleN = () => document.getElementById('nav-o').classList.toggle('show');
        window.onload = renderOrder;
    </script>
</body>
</html>